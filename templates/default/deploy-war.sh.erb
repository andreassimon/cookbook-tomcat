#!/bin/bash
if [ $# -ne 1 ]; then
  echo "Usage: $0 <war-file>"
  exit 1
fi

set -e
retry=60
war_file=$1

current_link=`readlink /etc/haproxy/haproxy.cfg`
if [ $current_link = "./haproxy.green.cfg" ]; then
  current_environment="GREEN"
  target_environment="BLUE"
  target_service="tomcat6-blue"
  target_port="8080"
  target_webapps="/var/lib/tomcat6-blue/webapps"
  target_config_file="./haproxy.blue.cfg"
fi
if [ $current_link = "./haproxy.blue.cfg" ]; then
  current_environment="BLUE"
  target_environment="GREEN"
  target_service="tomcat6-green"
  target_port="8081"
  target_webapps="/var/lib/tomcat6-green/webapps"
  target_config_file="./haproxy.green.cfg"
fi
echo "haproxy is connected to $current_environment backend"

curl --user deployer:supersecret http://localhost:$target_port/manager/undeploy?path=/
service $target_service stop

cp --verbose $war_file $target_webapps/ROOT.war
service $target_service start
until curl --head --fail --max-time 10 http://localhost:$target_port/; do
    if [ $retry -le 0 ]; then
      echo "App was not deployed successfully within retry limit"
      exit 1
    fi
    echo "Waiting 5 secs for successful deployment"
    sleep 5
    echo "$((--retry)) attempts remaining"
done
ln --symbolic --force --no-target-directory --verbose $target_config_file /etc/haproxy/haproxy.cfg
service haproxy reload
